{% extends "users/base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/post.css">
    <link rel="stylesheet" href="/static/css/like.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

{% endblock %}
{% block content %}
    {% if page == 1 %}
        {% if current_user %}
            <h1 class="mb-4">Привет, {{ current_user.profile.first_name or 'Друг' }}!</h1>
        {% else %}
            <h1 class="mb-4">Hello, Anonymous!</h1>
        {% endif %}
    {% endif %}
    {% include "users/create_post_form.html" %}

    <div class="post-list" id="post-list">
        {% if posts %}
            {% for post in posts %}
                <div class="post-item" id="post-{{ post.id }}">
                    <div class="post-header">
                        <img src="{{ post.author.profile.avatar }}"
                             alt="Автор" class="post-author-avatar">
                        <div>
                            <span class="post-author">{{ post.author.profile.full_name or post.author.username }}</span>
                        </div>
                    </div>

                    {% if post.image %}
                        <div>
                            <img src="{{ post.image }}" alt="Пост" class="post-image">
                        </div>
                    {% endif %}

                    {% if post.content %}
                        <div class="post-content">{{ post.content }}</div>
                    {% endif %}

                    <div class="post-actions">
                        <div class="like-container" data-post-id="{{ post.id }}">
                            <button class="like-button {% if post.is_liked_by_current %}liked{% endif %}">
                                <i class="fa-heart {% if post.is_liked_by_current %}fas{% else %}far{% endif %}"></i>
                                <span class="like-text">Нравится</span>
                                {% if post.likes_count > 0 %}
                                    <span class="like-counter">{{ post.likes_count }}</span>
                                {% endif %}
                            </button>
                        </div>
                    </div>

                    <div class="post-action">
                        <i class="far fa-comment"></i>
                        <span>Комментировать</span>
                    </div>
                    {% if is_own_profile or current_user.is_superuser %}
                        <div class="post-action">
                            <i class="far fa-trash-alt"></i>
                            <button class="delete-post-btn" data-post-id="{{ post.id }}"
                                    style="background: none; border: none; color: red; cursor: pointer;">
                                Удалить
                            </button>
                        </div>
                        <!-- Кнопка редактирования -->
                        <button class="edit-post-btn btn btn-sm btn-outline-primary"
                                data-post-id="{{ post.id }}" style="margin-left: 10px;">
                            <i class="fas fa-edit"></i> Редактировать
                        </button>
                    {% endif %}


                    <div class="post-date">
                        {{ post.created_at.strftime('%d.%m.%Y %H:%M') }}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="no-posts">
                <i class="far fa-newspaper fa-2x mb-3"></i>
                <p>Постов пока нет</p>
                {% if is_own_profile %}
                    <p>Создайте первый пост, чтобы поделиться новостями</p>
                {% endif %}
            </div>
        {% endif %}

    </div>
    <nav aria-label="Пагинация">
        <ul class="pagination justify-content-center mt-4">
            {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ request.url.include_query_params(page=page - 1) }}">Назад</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#">Назад</a>
                </li>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ request.url.include_query_params(page=p) }}">{{ p }}</a>
                </li>
            {% endfor %}

            {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ request.url.include_query_params(page=page + 1) }}">Вперёд</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#">Вперёд</a>
                </li>
            {% endif %}
        </ul>
    </nav>

    <script src=/static/js/posts.js type=text/javascript></script>
    <script src=/static/js/post-update.js type="text/javascript"></script>
    <script src=/static/js/show_toast.js type=text/javascript></script>
    <script src=/static/js/like.js type=text/javascript></script>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {
            setupPostUpdateHandlers();
            initLikeHandlers();

        });
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el);
        });
    </script>
{% endblock %}
